<!DOCTYPE html>
<html ng-app="FooForm">
<head lang="en">
    <meta charset="UTF-8">
    <title><%= formName %></title>
    <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap-theme.css">
    <style>
        .br0 {
            border-radius: 0;
        }

        .b0 {
            border: 0;
        }

        #formHeading h2 {
            font-size: 16px;
            font-weight: bold;
            line-height: 22px;
            margin: 0px;
            padding: 0px;
            display: inline-block;
        }

        #formHeading p {
            margin: 0px;
            padding: 0px;
            font-size: 10px;
            font-weight: normal;
            line-height: 14px;
        }

        .inline {
            display: inline-block;
        }

        #formLayout, .formLayout {
            display: block;
            padding-bottom: 0px;
            background: #f7f7f7;
            border: 1px solid #efefef;
        }

        .modal.fade {
            bottom: -100%;
            -webkit-transition: opacity 0.3s linear, left 0.3s ease-out;
            -moz-transition: opacity 0.3s linear, left 0.3s ease-out;
            -o-transition: opacity 0.3s linear, left 0.3s ease-out;
            transition: opacity 0.3s linear, left 0.3s ease-out;
        }

        .modal.fade.in {

            top: auto;
            bottom: 150px;

        }

        select.form-control {
            margin-right: 10px !important;
        }

        /*placeholder for draggies*/
        #formFields div.fieldObject, #formEvents div.fieldObject {
            clear: both !important;
            padding: 30px !important;
            border-radius: 0px !important;
            border: 1px solid #EFE3AE;
        }

        textarea.tandc {
            display: block;
            min-height: 400px;
            min-width: 540px !important;
        }

        .icons a {
            border: 3px solid #fff;
            display: inline-block;
            padding: 4px;
            margin: 0px;
        }

        .icons a:hover {
            border: 3px solid #D2E5F7;

        }

        img.icon {
            max-width: 48px;
            margin: 4px;
        }

        label i.fa {
            font-size: 1.4em;
            color: #185aa7;
            margin-left: 5px;
        }

        img.icon {
            max-height: 48px !important;
            display: inline-block;
            vertical-align: middle;
        }

        .inline {
            display: inline;
        }


    </style>
    <script type="text/javascript" src="/vendor/jquery/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="/vendor/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>
    <script type="text/javascript" src="/vendor/angular/angular-sanitize.min.js"></script>

    <script src="/vendor/pikaday/pikaday.js"></script>
    <script src="/vendor/pikaday/pikaday-directive.js"></script>


    <script>

        var FooForm = angular.module('FooForm', ['ngSanitize', 'pikaday']);
        FooForm.controller('FormCtrl', function ($scope, $http) {
            var formId = '<%- formId %>';
            $scope.sorted = false;
            $scope.errorPosting = false;
            $http({
                url: '/forms/repo/fetch/' + formId,
                method: 'GET'
            }).success(function (data) {
                $scope.post = angular.copy(data);
                $scope.post.form = data._id;
                delete $scope.post._id;

            }).error(function (data, status) {
                $scope.error = status;
            });
            $scope.submit = function () {
                $http({
                    url: '/forms/repo/post',
                    method: "POST",
                    data: $scope.post,
                    headers: {'Content-Type': 'application/json'}
                }).success(function () {
                    $scope.sorted = true;
                    $scope.$apply();
                }).error(function (data, status) {
                    $scope.sorted = false;
                    $scope.errorPosting = true;
                    $scope.status = status;
                    $scope.$apply();
                });
            };
        }).directive('compile', function ($compile) {
            'use strict';
            // directive factory creates a link function
            return function (scope, element, attrs) {
                scope.$watch(
                        function (scope) {
                            // watch the 'compile' expression for changes
                            return scope.$eval(attrs.compile);
                        },
                        function (value) {
                            // when the 'compile' expression changes
                            // assign it into the current DOM
                            element.html(value);

                            // compile the new DOM and link it to the current
                            // scope.
                            // NOTE: we only compile .childNodes so that
                            // we don't get into infinite loop compiling ourselves
                            $compile(element.contents())(scope);
                        }
                );
            };
        });

        function nl2br(str, is_xhtml) {

            var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br ' + '/>' : '<br>'; // Adjust comment to avoid issue on phpjs.org display

            return (str + '')
                    .replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
        }
    </script>
</head>
<body ng-controller="FormCtrl">

<div id='formLayout' class="container">
    <div compile="post.settings.customFormHtml"></div>
    <form role="form" class="panel panel-info b0">

        <div class="foo-header panel-heading text-info">
            <img class="icon pull-left" ng-src="{{post.icon}}" alt="">
            <h4 class="inline p0 text-info">{{post.name}}</h4>

            <p class="text-primary">{{ post.description}}</p>
        </div>
        <div class="foo-body panel-body">

            <div class="row" ng-hide="sorted">
                <div class='col-sm-{{formField.boxSize}} under viewFormObject'
                     ng-repeat="formField in post.fields track by $index"
                     ng-show="!formField.adminOnly">

                    <div ng-include='formField.template'></div>
                </div>
            </div>
        </div>
    </form>
    <div class="row" ng-show="errorPosting">
        <div class="col-sm-12 p5 alert alert-success">
            <h4>Oops!</h4>

            <p>There seems to have been an error processing your form. Please review and try again.<br>{{status}}</p>
        </div>
    </div>


    <div class="modal fade" id="tandc" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Terms & Conditions</h4>
                </div>
                <div class="modal-body input-group">
                    <textarea ng-model="post.settings.tandcHtml" class="tandc form-control"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row" ng-show="post.settings.tandcWeb" ng-hide="sorted">
        <div class="col-sm-12 p5 alert alert-info">
            <input type="checkbox" ng-model="tandcAccepted"> I accept the <a data-toggle="modal" data-target="#tandc">Terms
            & Conditions</a>
            <button id='savePost' ng-click="submit()" ng-disabled="!tandcAccepted"
                    class="btn btn-primary pull-right">Submit
            </button>
        </div>
    </div>
    <div class="row" ng-hide="post.settings.tandcWeb || sorted">
        <div class="col-sm-12 p5">

            <button id='savePostNoTC' ng-click="submit()"
                    class="btn btn-primary">Submit
            </button>
        </div>
    </div>
    <div class="row" ng-show="sorted">
        <div class="col-sm-12 p5 alert alert-success br0">
            <h4>Thank you</h4>

            <p>Your order has been received.</p>
        </div>
    </div>

</div>

</body>
</html>
